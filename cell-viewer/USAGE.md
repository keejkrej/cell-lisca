# Cell Viewer Usage Guide

Cell Viewer is an interactive PySide6-based application for visualizing and analyzing NPY files generated by cell-filter. It provides a user-friendly interface for exploring microscopy data, selecting frame ranges, and extracting specific intervals for further analysis.

## Overview

Cell Viewer offers the following capabilities:

- Interactive visualization of multi-channel NPY data
- Frame-by-frame navigation through timelapse sequences
- Interval selection for extracting specific time ranges
- Channel switching and display adjustments
- Export of selected frames as new NPY files

## Launching the Application

### Command Line Usage

```bash
cell-viewer
```

Or via Python module:

```bash
python -m cell_viewer
```

### Examples

```bash
# Launch the application
cell-viewer
```

**Note**: The `cell-viewer` script is recommended for easier usage. The application does not accept command-line file arguments. Files must be opened through the application's file menu after launch.

## User Interface Overview

Cell Viewer features an intuitive interface with several key components:

### Main Window Layout

```
┌─────────────────────────────────────────────────────────────┐
│ Menu Bar: File | View | Tools | Help                        │
├─────────────────────────────────────────────────────────────┤
│ Toolbar: [Open] [Save] [Play] [Reset] [Info]               │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────────────────────────┐ │
│ │                 │ │                                     │ │
│ │   Image         │ │      Controls Panel                 │ │
│ │   Display       │ │                                     │ │
│ │                 │ │ • Channel Selection                 │ │
│ │                 │ │ • Frame Controls                   │ │
│ │                 │ │ • Interval Controls                │ │
│ │                 │ │ • Display Settings                 │ │
│ └─────────────────┘ └─────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ Status Bar: Frame info | File info | Processing status     │
└─────────────────────────────────────────────────────────────┘
```

## File Operations

### Opening Files

1. **Menu**: File → Open
2. **Toolbar**: Click the Open button
3. **Keyboard**: Ctrl+O (Cmd+O on Mac)
4. **Command Line**: Pass file path when launching

### Supported File Formats

- NPY files generated by cell-filter
- Multi-dimensional arrays with shape `(frames, channels, height, width)`
- Files with associated YAML metadata

### Saving Files

1. **Menu**: File → Save Interval
2. **Toolbar**: Click the Save button
3. **Keyboard**: Ctrl+S (Cmd+S on Mac)

## Navigation Controls

### Frame Navigation

| Control           | Description                         |
| ----------------- | ----------------------------------- |
| **Play/Pause**    | Automatic playback of frames        |
| **Step Forward**  | Move to next frame                  |
| **Step Backward** | Move to previous frame              |
| **Frame Slider**  | Direct navigation to specific frame |
| **Frame Input**   | Jump to specific frame number       |

### Keyboard Shortcuts

| Key       | Action         |
| --------- | -------------- |
| **Space** | Play/Pause     |
| **→**     | Next frame     |
| **←**     | Previous frame |
| **Home**  | First frame    |
| **End**   | Last frame     |
| **+**     | Zoom in        |
| **-**     | Zoom out       |
| **0**     | Reset zoom     |

## Display Options

### Channel Selection

- **Channel Dropdown**: Select which channel to display
- **Auto-detection**: Automatically identifies fluorescence and segmentation channels
- **Custom Colormaps**: Different colormaps for different channel types

### Visualization Settings

| Setting           | Options                         | Description                |
| ----------------- | ------------------------------- | -------------------------- |
| **Colormap**      | grayscale, viridis, plasma, jet | Color scheme for display   |
| **Interpolation** | nearest, bilinear, bicubic      | Image interpolation method |
| **Scale Bar**     | On/Off                          | Display scale information  |
| **Grid**          | On/Off                          | Display overlay grid       |

## Interval Selection

### Setting Frame Range

1. **Start Frame**: Set the beginning of your interval
2. **End Frame**: Set the end of your interval
3. **Preview**: See selected frames highlighted
4. **Validate**: Check interval validity before export

### Interval Controls

| Control               | Description                      |
| --------------------- | -------------------------------- |
| **Start Frame Input** | Set first frame of interval      |
| **End Frame Input**   | Set last frame of interval       |
| **Include End**       | Whether to include the end frame |
| **Preview Button**    | Preview selected interval        |
| **Reset Button**      | Reset to full range              |

### Export Options

When saving intervals, you can choose:

| Option          | Description                       |
| --------------- | --------------------------------- |
| **Channels**    | Select which channels to include  |
| **Metadata**    | Include/exclude YAML metadata     |
| **Compression** | Compression level for output file |
| **Filename**    | Custom output filename            |

## Advanced Features

### Multi-Channel Viewing

- **Split Screen View**: View multiple channels simultaneously
- **Overlay Mode**: Overlay segmentation on fluorescence channels
- **Channel Blending**: Adjust opacity for overlay visualization

### Measurement Tools

- **Distance Measurement**: Measure distances between points
- **Area Measurement**: Calculate areas of regions
- **Intensity Profiling**: Plot intensity along lines
- **Cell Counting**: Manual cell counting tools

### Analysis Features

- **Frame Statistics**: Display statistics for current frame
- **Intensity Histograms**: Show intensity distribution
- **Temporal Plots**: Plot intensity changes over time
- **Export Data**: Export measurements and statistics

## API Usage

### Programmatic Access

```python
from cell_viewer.main import CellViewer
from cell_viewer.ui.main_window import MainWindow

# Create viewer instance
viewer = CellViewer()

# Load file
viewer.load_file("data.npy")

# Set interval
viewer.set_interval(start_frame=10, end_frame=50)

# Extract and save
viewer.extract_interval("output.npy", channels=[0, 1, 2])
```

### Custom Integration

```python
from PySide6.QtWidgets import QApplication
from cell_viewer.ui.main_window import MainWindow

app = QApplication([])
window = MainWindow()
window.load_file("data.npy")
window.show()
app.exec()
```

## Keyboard Reference

### File Operations

- **Ctrl+O**: Open file
- **Ctrl+S**: Save interval
- **Ctrl+Shift+S**: Save as
- **Ctrl+W**: Close file
- **Ctrl+Q**: Quit application

### Navigation

- **Space**: Play/Pause
- **→/←**: Next/Previous frame
- **Home/End**: First/Last frame
- **PgUp/PgDn**: Jump 10 frames

### Display

- **+/-**: Zoom in/out
- **0**: Reset zoom
- **F**: Fullscreen mode
- **I**: Toggle information display
- **G**: Toggle grid

### Analysis

- **M**: Measurement mode
- **C**: Cell counting mode
- **H**: Toggle histogram
- **P**: Plot intensity profile

## Troubleshooting

### Common Issues

1. **File Loading Errors**

   - Check file format compatibility
   - Verify file permissions
   - Ensure sufficient memory for large files

2. **Performance Issues**

   - Reduce display resolution for large images
   - Close unnecessary applications
   - Use frame caching for smoother playback

3. **Display Problems**
   - Check graphics drivers
   - Try different interpolation methods
   - Reset display settings

### Error Messages

| Error              | Solution                                      |
| ------------------ | --------------------------------------------- |
| "Cannot load file" | Verify file is valid NPY format               |
| "Out of memory"    | Close other applications or use smaller files |
| "Invalid interval" | Check start/end frame values                  |

## Integration with Cell-LISCA

Cell Viewer works seamlessly with other Cell-LISCA components:

### Workflow Integration

```bash
# 1. Process with cell-filter
cell-filter-extract --input ./filtered --output ./extracted

# 2. Analyze with cell-grapher
cell-grapher --input ./extracted/data.npy --output ./analysis

# 3. View and select intervals with cell-viewer
cell-viewer ./extracted/data.npy

# 4. Use selected intervals for further analysis
```

### Data Transfer

- Cell Viewer can open NPY files directly from cell-filter output
- Selected intervals can be fed back into cell-grapher for focused analysis
- Metadata is preserved throughout the workflow

## Performance Optimization

### Memory Management

- **Frame Caching**: Adjustable cache size for smooth playback
- **Lazy Loading**: Load frames only when needed
- **Memory Monitoring**: Built-in memory usage tracking

### Display Optimization

- **Resolution Scaling**: Automatic resolution adjustment for performance
- **Background Loading**: Load frames in background threads
- **GPU Acceleration**: Hardware acceleration when available

## Customization

### User Preferences

Access preferences through:

- **Menu**: Edit → Preferences
- **Keyboard**: Ctrl+, (comma)

### Customizable Settings

- **Default colormap**
- **Playback speed**
- **Cache size**
- **Export format**
- **Keyboard shortcuts**

### Themes

- **Light Theme**: Default bright theme
- **Dark Theme**: Dark interface for low-light environments
- **Custom Themes**: Import custom color schemes

## Tips and Tricks

### Efficient Workflow

1. **Preprocessing**: Use cell-filter to preprocess data before viewing
2. **Interval Selection**: Select specific intervals before detailed analysis
3. **Batch Processing**: Save intervals for automated processing
4. **Keyboard Shortcuts**: Learn shortcuts for faster navigation

### Advanced Usage

1. **Multi-file Analysis**: Open multiple files for comparison
2. **Synchronized Playback**: Sync multiple viewers for comparison
3. **Data Export**: Export measurements for external analysis
4. **Scripting**: Use API for automated workflows

## Support

For additional help:

- Check the built-in help: Help → Documentation
- Report issues through the project repository
- Contact the development team at ctyjackcao@outlook.com
