# Cell Grapher Usage Guide

Cell Grapher is a specialized tool for analyzing cellular dynamics in micropatterned timelapse microscopy data. It performs cell tracking, constructs region adjacency graphs, and analyzes topological transitions (T1 transitions) in cellular arrays.

## Overview

Cell Grapher works with pre-computed segmentation masks from cell-filter output, focusing on:

- Cell tracking across timeframes using IoU-based alignment
- Region adjacency graph construction
- T1 transition analysis
- Visualization of cellular dynamics

## Command Line Usage

### Basic Usage

```bash
cell-grapher --input data.npy --output ./output
```

Or via Python module:

```bash
python -m cell_grapher --input data.npy --output ./output
```

**Note**: The `cell-grapher` script is recommended for easier usage.

### Command Line Options

| Option               | Description                                      | Default                       |
| -------------------- | ------------------------------------------------ | ----------------------------- |
| `--input, -i`        | Path to cell-filter NPY file                     | Required                      |
| `--output, -o`       | Output directory                                 | Required                      |
| `--yaml, -y`         | Path to YAML metadata file                       | Auto-detected                 |
| `--start-frame, -s`  | Starting frame number                            | Auto-detects first frame      |
| `--end-frame, -e`    | Ending frame number (exclusive)                  | Process all frames            |
| `--search-radius`    | Maximum search radius for cell tracking (pixels) | 100.0                         |
| `--tracking-config`  | Path to btrack config JSON file                  | Uses default if not specified |
| `--adjacency-method` | Method for building adjacency graphs             | boundary_length               |
| `--validate-only`    | Only validate input format, don't run analysis   | False                         |

### Advanced Examples

```bash
# Basic analysis
cell-grapher --input fov_000_pattern_000_seq_000.npy --output ./tracking_output

# With custom parameters
cell-grapher \
  --input fov_000_pattern_000_seq_000.npy \
  --output ./tracking_output \
  --yaml fov_000_pattern_000_seq_000.yaml \
  --start-frame 10 \
  --end-frame 50 \
  --search-radius 80.0 \
  --adjacency-method centroid_distance

# With custom tracking config
cell-grapher \
  --input fov_000_pattern_000_seq_000.npy \
  --output ./tracking_output \
  --tracking-config /path/to/btrack_config.json

# Validate input format only
cell-grapher --input fov_000_pattern_000_seq_000.npy --validate-only
```

## API Usage

### Simple Analysis

```python
from cell_grapher.pipeline import analyze_cell_filter_data

results = analyze_cell_filter_data(
    npy_path="fov_000_pattern_000_seq_000.npy",
    yaml_path="fov_000_pattern_000_seq_000.yaml",  # optional
    output_dir="tracking_analysis",
    start_frame=None,  # optional, auto-detects first frame
    end_frame=None    # optional, processes all frames
)
```

### Advanced Analysis

```python
from cell_grapher.pipeline import CellGrapherPipeline
from cell_grapher.core.graph import GraphBuilder
from cell_grapher.tracking import CellTracker

# Create custom pipeline
pipeline = CellGrapherPipeline(
    iou_threshold=0.25,
    adjacency_method="centroid_distance"
)

# Process data
results = pipeline.process(
    npy_path="data.npy",
    yaml_path="metadata.yaml",
    output_dir="./output",
    start_frame=10,
    end_frame=100
)

# Access results
tracked_cells = results.tracked_cells
adjacency_graphs = results.adjacency_graphs
t1_transitions = results.t1_transitions
```

## Input Requirements

### NPY File Format

Cell Grapher expects NPY files generated by cell-filter with the following specifications:

- **Shape**: `(n_frames, n_channels+2, height, width)`
- **Channels**: `[pattern, cell_channels..., segmentation]`
- **Segmentation Channel**: Last channel with local cell IDs (background=0, cells=1,2,3,...)

### YAML Metadata (Optional)

```yaml
start_frame: int
end_frame: int
channels: ["pattern", "channel1", "channel2", ..., "segmentation"]
pattern_bbox: [x, y, w, h]
```

## Output Files

Cell Grapher generates several output files in the specified directory:

### 1. Tracked Cell Data

- `tracked_cells.npy`: Array with tracked cell masks and global IDs
- `cell_tracks.csv`: CSV file with cell tracking information

### 2. Graph Analysis

- `adjacency_graphs.pkl`: Pickled region adjacency graphs for each frame
- `graph_metrics.csv`: Graph metrics over time

### 3. T1 Transition Analysis

- `t1_transitions.csv`: Detected T1 transitions with timestamps
- `t1_analysis.png`: Visualization of T1 transition statistics
- `topology_tracking.png`: Plot of topology changes over time

### 4. Visualization

- `cell_analysis_video.mp4`: Three-panel video showing:
  - Panel 1: Nuclei fluorescence channel (grayscale)
  - Panel 2: Cytoplasm fluorescence channel (grayscale)
  - Panel 3: Segmentation mask with overlaid adjacency graph

## Analysis Methods

### Cell Tracking

Cell Grapher uses Intersection over Union (IoU) based tracking:

1. **IoU Calculation**: Compute overlap between cell masks in consecutive frames
2. **Matching**: Assign cells between frames based on maximum IoU
3. **Global ID Assignment**: Maintain consistent global IDs across the sequence

### Graph Construction

Multiple methods for building region adjacency graphs:

| Method              | Description                                         |
| ------------------- | --------------------------------------------------- |
| `boundary_length`   | Graph based on shared boundary length between cells |
| `centroid_distance` | Graph based on distance between cell centroids      |
| `direct_contact`    | Binary graph indicating direct cell contact         |

### T1 Transition Detection

T1 transitions are identified by analyzing changes in adjacency relationships:

1. **Edge Monitoring**: Track appearance/disappearance of cell-cell contacts
2. **Transition Classification**: Identify specific T1 transition types
3. **Temporal Analysis**: Analyze timing and frequency of transitions

## Visualization Features

### Three-Panel Video

The generated video shows synchronized views:

- **Left Panel**: Nuclei channel for nuclear dynamics
- **Middle Panel**: Cytoplasm channel for cellular morphology
- **Right Panel**: Segmentation with graph overlay showing cell relationships

### Static Plots

- **Topology Tracking**: Line plot showing number of cells, edges, and topological changes
- **T1 Transition Analysis**: Bar charts and histograms of transition events

## Performance Considerations

### Memory Usage

- Large datasets may require significant memory for graph storage
- Consider processing in chunks for very long time series

### Processing Speed

- IoU calculations are the most computationally intensive step
- Adjust `iou_threshold` to balance accuracy vs. speed
- Use smaller frame ranges for initial testing

## Troubleshooting

### Common Issues

1. **Memory Errors**: Reduce frame range or process in smaller chunks
2. **Poor Tracking**: Adjust `iou-threshold` parameter
3. **Missing T1 Transitions**: Check adjacency method sensitivity

### Validation

Use the `--validate-only` flag to check input format before processing:

```bash
cell-grapher --input data.npy --validate-only
```

## Integration with Cell-Filter

Cell Grapher is designed to work seamlessly with cell-filter output:

```bash
# Process with cell-filter
cell-filter-extract --input ./filtered --output ./extracted

# Analyze with cell-grapher
cell-grapher --input ./extracted/fov_000_pattern_000_seq_000.npy --output ./analysis
```

## Advanced Configuration

### Custom Tracking Parameters

```python
from cell_grapher.tracking import CellTracker

tracker = CellTracker(
    iou_threshold=0.25,
    min_cell_size=10,
    max_cell_size=1000,
    allow_splitting=False,
    allow_merging=False
)
```

### Custom Graph Methods

```python
from cell_grapher.core.graph import GraphBuilder

builder = GraphBuilder(
    method="custom",
    distance_threshold=50,
    min_boundary_length=5
)
```

## Output Interpretation

### T1 Transition Types

- **Type 1**: Neighbor exchange through four-cell junction
- **Type 2**: Cell insertion/removal
- **Type 3**: Complex multi-cell rearrangements

### Graph Metrics

- **Coordination Number**: Average number of neighbors per cell
- **Network Density**: Ratio of actual to possible edges
- **Clustering Coefficient**: Measure of local connectivity

## Reference Implementation

For detailed examples of how to use Cell Grapher in research workflows, see the `example_usage.py` file in the cell-grapher directory.
