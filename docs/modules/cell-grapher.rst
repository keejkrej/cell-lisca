cell-grapher: Cell Tracking & Graph Analysis
============================================

cell-grapher is the third module in the Cell-LISCA pipeline, responsible for tracking cells across time and analyzing topological transitions through region adjacency graphs.

Overview
--------

The cell-grapher module takes NPY files with segmentation masks from cell-filter and performs:

1. **Cell Tracking**: Track individual cells across frames using IoU-based alignment
2. **Graph Construction**: Build region adjacency graphs for each frame
3. **T1 Transition Detection**: Identify topological rearrangements
4. **Visualization**: Create videos and plots of cellular dynamics

The module uses intersection-over-union (IoU) for tracking and NetworkX for graph analysis.

Command Line Interface
----------------------

Basic Usage
~~~~~~~~~~~

.. code-block:: bash

   cell-grapher --input data.npy --output ./analysis

Or via Python module:

.. code-block:: bash

   python -m cell_grapher --input data.npy --output ./analysis

Command Options
~~~~~~~~~~~~~~~

.. option:: --input, -i <PATH>

   Path to cell-filter NPY file containing timelapse data with segmentation channel (required).

.. option:: --output, -o <PATH>

   Output directory for analysis results (required).

.. option:: --yaml, -y <PATH>

   Path to corresponding YAML metadata file (optional, auto-detected if not provided).

.. option:: --start-frame, -s <INT>

   Starting frame number (processes from first frame if not specified).

.. option:: --end-frame, -e <INT>

   Ending frame number (exclusive, processes all frames if not specified).

.. option:: --search-radius <FLOAT>

   Maximum search radius for cell tracking in pixels. Default: ``100.0``

.. option:: --tracking-config <PATH>

   Path to btrack config JSON file (optional, uses default if not specified).

.. option:: --adjacency-method <METHOD>

   Method for building adjacency graphs. Choices: ``boundary_length``, ``centroid_distance``. Default: ``boundary_length``

.. option:: --validate-only

   Only validate input format, don't run analysis.

Examples
~~~~~~~~

.. code-block:: bash

   # Basic analysis
   cell-grapher --input fov_000_pattern_000_seq_000.npy --output ./tracking_output

   # With custom parameters
   cell-grapher \
     --input fov_000_pattern_000_seq_000.npy \
     --output ./tracking_output \
     --yaml fov_000_pattern_000_seq_000.yaml \
     --start-frame 10 \
     --end-frame 50 \
     --search-radius 80.0 \
     --adjacency-method centroid_distance

   # Validate input format only
   cell-grapher --input data.npy --validate-only

Input Requirements
------------------

NPY File Format
~~~~~~~~~~~~~~~

cell-grapher expects NPY files generated by cell-filter with the following specifications:

- **Shape**: ``(n_frames, n_channels+2, height, width)``
- **Channels**: ``[pattern, cell_channels..., segmentation]``
- **Segmentation Channel**: Last channel with local cell IDs (background=0, cells=1,2,3,...)

Example data structure:

.. code-block:: python

   # Shape: (100 frames, 4 channels, 256x256 pixels)
   # Channels: [pattern, nuclei, cytoplasm, segmentation]
   data = np.load('sequence.npy')
   print(data.shape)  # (100, 4, 256, 256)

YAML Metadata (Optional)
~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: yaml

   start_frame: 0
   end_frame: 100
   channels: ["pattern", "nuclei", "cytoplasm", "segmentation"]
   pattern_bbox: [100, 100, 50, 50]  # x, y, width, height

Output Files
------------

Cell Grapher generates several output files in the specified directory:

Tracked Cell Data
~~~~~~~~~~~~~~~~~

- **tracked_cells.npy**: Array with tracked cell masks and global IDs
- **cell_tracks.csv**: CSV file with cell tracking information

Graph Analysis
~~~~~~~~~~~~~~

- **adjacency_graphs.pkl**: Pickled region adjacency graphs for each frame
- **graph_metrics.csv**: Graph metrics over time

T1 Transition Analysis
~~~~~~~~~~~~~~~~~~~~~

- **t1_transitions.csv**: Detected T1 transitions with timestamps
- **t1_analysis.png**: Visualization of T1 transition statistics
- **topology_tracking.png**: Plot of topology changes over time

Visualization
~~~~~~~~~~~~~

- **cell_analysis_video.mp4**: Three-panel video showing:
  - Panel 1: Nuclei fluorescence channel (grayscale)
  - Panel 2: Cytoplasm fluorescence channel (grayscale)
  - Panel 3: Segmentation mask with overlaid adjacency graph

Algorithm Details
-----------------

Cell Tracking Algorithm
~~~~~~~~~~~~~~~~~~~~~~~

1. **IoU Calculation**: Compute intersection-over-union between cell masks in consecutive frames
2. **Matching**: Assign cells between frames based on maximum IoU
3. **Global ID Assignment**: Maintain consistent global IDs across the sequence
4. **Handling Splits/Merges**: Optional btrack integration for complex events

The tracking uses these key parameters:

- **IoU Threshold**: Minimum overlap for cell matching (default: 0.25)
- **Search Radius**: Maximum distance for cell matching (default: 100 pixels)
- **Max Gap**: Maximum frames a cell can be missing (configurable)

Graph Construction Methods
~~~~~~~~~~~~~~~~~~~~~~~~~~

Boundary Length Method
^^^^^^^^^^^^^^^^^^^^^

- Creates edges between cells sharing boundaries
- Edge weight = length of shared boundary
- More accurate for mechanical analysis

Centroid Distance Method
^^^^^^^^^^^^^^^^^^^^^^

- Creates edges between nearby cells
- Edge weight = distance between centroids
- Faster but less physically meaningful

T1 Transition Detection
~~~~~~~~~~~~~~~~~~~~~~~

T1 transitions are identified by analyzing changes in adjacency relationships:

1. **Edge Monitoring**: Track appearance/disappearance of cell-cell contacts
2. **Transition Classification**: Identify specific T1 transition types
3. **Temporal Analysis**: Analyze timing and frequency of transitions

T1 Transition Types:

- **Type 1**: Neighbor exchange through four-cell junction
- **Type 2**: Cell insertion/removal
- **Type 3**: Complex multi-cell rearrangements

API Usage
---------

Pipeline API
~~~~~~~~~~~~

.. code-block:: python

   from cell_grapher.pipeline import analyze_cell_filter_data

   results = analyze_cell_filter_data(
       npy_path="fov_000_pattern_000_seq_000.npy",
       yaml_path="metadata.yaml",  # optional
       output_dir="tracking_analysis",
       start_frame=None,  # optional
       end_frame=None    # optional
   )

Advanced API
~~~~~~~~~~~~

.. code-block:: python

   from cell_grapher.pipeline import CellGrapherPipeline
   from cell_grapher.core.graph import GraphBuilder
   from cell_grapher.tracking import CellTracker

   # Create custom pipeline
   pipeline = CellGrapherPipeline(
       iou_threshold=0.25,
       adjacency_method="centroid_distance"
   )

   # Process data
   results = pipeline.process(
       npy_path="data.npy",
       yaml_path="metadata.yaml",
       output_dir="./output",
       start_frame=10,
       end_frame=100
   )

   # Access results
   tracked_cells = results.tracked_cells
   adjacency_graphs = results.adjacency_graphs
   t1_transitions = results.t1_transitions

Core Classes
~~~~~~~~~~~~

.. autoclass:: cell_grapher.pipeline.CellGrapherPipeline
   :members:
   :undoc-members:

.. autoclass:: cell_grapher.tracking.CellTracker
   :members:
   :undoc-members:

.. autoclass:: cell_grapher.core.graph.GraphBuilder
   :members:
   :undoc-members:

.. autoclass:: cell_grapher.segmentation.SegmentationLoader
   :members:
   :undoc-members:

Performance Considerations
--------------------------

Memory Usage
~~~~~~~~~~~~

- Large datasets may require significant memory for graph storage
- Consider processing in chunks for very long time series
- Each frame's graph is stored independently

Processing Speed
~~~~~~~~~~~~~~~~

- IoU calculations are the most computationally intensive step
- Adjust IoU threshold to balance accuracy vs. speed
- Use smaller frame ranges for initial testing

Optimization Tips
~~~~~~~~~~~~~~~~

1. **Frame Range**: Process subsets first to test parameters
2. **IoU Threshold**: Higher values = faster but less accurate tracking
3. **Adjacency Method**: Centroid distance is faster than boundary length
4. **Parallel Processing**: Some operations can be parallelized

Troubleshooting
---------------

Common Issues
~~~~~~~~~~~~~

1. **Memory Errors**
   - Reduce frame range or process in smaller chunks
   - Ensure sufficient RAM for dataset size

2. **Poor Tracking**
   - Adjust IoU threshold parameter
   - Check segmentation quality
   - Verify frame rate is appropriate

3. **Missing T1 Transitions**
   - Check adjacency method sensitivity
   - Verify graph construction parameters
   - Ensure sufficient temporal resolution

4. **Validation Errors**
   - Check NPY file format
   - Verify segmentation channel is last
   - Ensure cell IDs are integers starting from 1

Validation
~~~~~~~~~~

Use the ``--validate-only`` flag to check input format:

.. code-block:: bash

   cell-grapher --input data.npy --validate-only

This checks:
- File exists and is readable
- NPY array has correct dimensions
- Segmentation channel contains valid cell IDs
- YAML metadata (if present) is valid

Integration with Pipeline
------------------------

Cell Grapher is the third step in the Cell-LISCA pipeline:

1. **cell-pattern extract** → Creates HDF5 with bounding boxes
2. **cell-filter analysis + extract** → Adds cell counts and segmentation
3. **Export to NPY** → Convert sequences to NPY format
4. **cell-grapher** → Track cells and analyze dynamics
5. **cell-tensionmap** → Use segmentation for stress inference

The output from cell-grapher can be used for:
- Quantitative analysis of cell dynamics
- Statistical studies of T1 transitions
- Input for mechanical modeling
- Visualization in presentations
