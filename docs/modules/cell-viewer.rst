cell-viewer: Interactive Visualization
======================================

cell-viewer is the fifth module in the Cell-LISCA pipeline, providing an interactive PySide6-based GUI application for visualizing and exploring NPY files generated by cell-filter.

Overview
--------

cell-viewer offers a user-friendly interface for:

- Interactive visualization of multi-channel NPY data
- Frame-by-frame navigation through timelapse sequences
- Interval selection for extracting specific time ranges
- Channel switching and display adjustments
- Export of selected frames as new NPY files
- Measurement tools and analysis features

The application provides real-time interaction with your microscopy data, making it easy to inspect results and select regions of interest for further analysis.

Launching the Application
-------------------------

Command Line
~~~~~~~~~~~~

.. code-block:: bash

   cell-viewer

Or via Python module:

.. code-block:: bash

   python -m cell_viewer

Note: The application does not accept command-line file arguments. Files must be opened through the application's file menu after launch.

User Interface
--------------

Main Window Layout
~~~~~~~~~~~~~~~~~~

The cell-viewer interface consists of several key components:

.. code-block:: text

   ┌─────────────────────────────────────────────────────────────┐
   │ Menu Bar: File | View | Tools | Help                        │
   ├─────────────────────────────────────────────────────────────┤
   │ Toolbar: [Open] [Save] [Play] [Reset] [Info]               │
   ├─────────────────────────────────────────────────────────────┤
   │ ┌─────────────────┐ ┌─────────────────────────────────────┐ │
   │ │                 │ │                                     │ │
   │ │   Image         │ │      Controls Panel                 │ │
   │ │   Display       │ │                                     │ │
   │ │                 │ │ • Channel Selection                 │ │
   │ │                 │ │ • Frame Controls                   │ │
   │ │                 │ │ • Interval Controls                │ │
   │ │                 │ │ • Display Settings                 │ │
   │ └─────────────────┘ └─────────────────────────────────────┘ │
   ├─────────────────────────────────────────────────────────────┤
   │ Status Bar: Frame info | File info | Processing status     │
   └─────────────────────────────────────────────────────────────┘

Key Components
~~~~~~~~~~~~~~

- **Image Display**: Central panel showing the current frame
- **Controls Panel**: Right-side panel with all controls
- **Menu Bar**: Access to file operations and settings
- **Toolbar**: Quick access to common functions
- **Status Bar**: Information about current state

File Operations
---------------

Opening Files
~~~~~~~~~~~~~

1. **Menu**: File → Open
2. **Toolbar**: Click the Open button
3. **Keyboard**: Ctrl+O (Cmd+O on Mac)

Supported File Formats
~~~~~~~~~~~~~~~~~~~~~~

- NPY files generated by cell-filter
- Multi-dimensional arrays with shape ``(frames, channels, height, width)``
- Files with associated YAML metadata

Saving Files
~~~~~~~~~~~~

1. **Menu**: File → Save Interval
2. **Toolbar**: Click the Save button
3. **Keyboard**: Ctrl+S (Cmd+S on Mac)

Navigation Controls
-------------------

Frame Navigation
~~~~~~~~~~~~~~~~

| Control           | Description                         |
| ----------------- | ----------------------------------- |
| **Play/Pause**    | Automatic playback of frames        |
| **Step Forward**  | Move to next frame                  |
| **Step Backward** | Move to previous frame              |
| **Frame Slider**  | Direct navigation to specific frame |
| **Frame Input**   | Jump to specific frame number       |

Keyboard Shortcuts
~~~~~~~~~~~~~~~~~~

| Key       | Action         |
| --------- | -------------- |
| **Space** | Play/Pause     |
| **→**     | Next frame     |
| **←**     | Previous frame |
| **Home**  | First frame    |
| **End**   | Last frame     |
| **+**     | Zoom in        |
| **-**     | Zoom out       |
| **0**     | Reset zoom     |

Display Options
---------------

Channel Selection
~~~~~~~~~~~~~~~~~

- **Channel Dropdown**: Select which channel to display
- **Auto-detection**: Automatically identifies fluorescence and segmentation channels
- **Custom Colormaps**: Different colormaps for different channel types

Visualization Settings
~~~~~~~~~~~~~~~~~~~~~~

| Setting           | Options                         | Description                |
| ----------------- | ------------------------------- | -------------------------- |
| **Colormap**      | grayscale, viridis, plasma, jet | Color scheme for display   |
| **Interpolation** | nearest, bilinear, bicubic      | Image interpolation method |
| **Scale Bar**     | On/Off                          | Display scale information  |
| **Grid**          | On/Off                          | Display overlay grid       |

Interval Selection
-----------------

Setting Frame Range
~~~~~~~~~~~~~~~~~~~

1. **Start Frame**: Set the beginning of your interval
2. **End Frame**: Set the end of your interval
3. **Preview**: See selected frames highlighted
4. **Validate**: Check interval validity before export

Interval Controls
~~~~~~~~~~~~~~~~~

| Control               | Description                      |
| --------------------- | -------------------------------- |
| **Start Frame Input** | Set first frame of interval      |
| **End Frame Input**   | Set last frame of interval       |
| **Include End**       | Whether to include the end frame |
| **Preview Button**    | Preview selected interval        |
| **Reset Button**      | Reset to full range              |

Export Options
~~~~~~~~~~~~~~

When saving intervals, you can choose:

| Option          | Description                       |
| --------------- | --------------------------------- |
| **Channels**    | Select which channels to include  |
| **Metadata**    | Include/exclude YAML metadata     |
| **Compression** | Compression level for output file |
| **Filename**    | Custom output filename            |

Advanced Features
-----------------

Multi-Channel Viewing
~~~~~~~~~~~~~~~~~~~~

- **Split Screen View**: View multiple channels simultaneously
- **Overlay Mode**: Overlay segmentation on fluorescence channels
- **Channel Blending**: Adjust opacity for overlay visualization

Measurement Tools
~~~~~~~~~~~~~~~~~

- **Distance Measurement**: Measure distances between points
- **Area Measurement**: Calculate areas of regions
- **Intensity Profiling**: Plot intensity along lines
- **Cell Counting**: Manual cell counting tools

Analysis Features
~~~~~~~~~~~~~~~~~

- **Frame Statistics**: Display statistics for current frame
- **Intensity Histograms**: Show intensity distribution
- **Temporal Plots**: Plot intensity changes over time
- **Export Data**: Export measurements and statistics

API Usage
---------

Programmatic Access
~~~~~~~~~~~~~~~~~~~

.. code-block:: python

   from cell_viewer.main import CellViewer
   from cell_viewer.ui.main_window import MainWindow

   # Create viewer instance
   viewer = CellViewer()

   # Load file
   viewer.load_file("data.npy")

   # Set interval
   viewer.set_interval(start_frame=10, end_frame=50)

   # Extract and save
   viewer.extract_interval("output.npy", channels=[0, 1, 2])

Custom Integration
~~~~~~~~~~~~~~~~~~

.. code-block:: python

   from PySide6.QtWidgets import QApplication
   from cell_viewer.ui.main_window import MainWindow

   app = QApplication([])
   window = MainWindow()
   window.load_file("data.npy")
   window.show()
   app.exec()

Core Classes
~~~~~~~~~~~~

.. autoclass:: cell_viewer.main.CellViewer
   :members:
   :undoc-members:

.. autoclass:: cell_viewer.ui.main_window.MainWindow
   :members:
   :undoc-members:

Performance Optimization
------------------------

Memory Management
~~~~~~~~~~~~~~~~~

- **Frame Caching**: Adjustable cache size for smooth playback
- **Lazy Loading**: Load frames only when needed
- **Memory Monitoring**: Built-in memory usage tracking

Display Optimization
~~~~~~~~~~~~~~~~~~~

- **Resolution Scaling**: Automatic resolution adjustment for performance
- **Background Loading**: Load frames in background threads
- **GPU Acceleration**: Hardware acceleration when available

Tips for Best Performance
~~~~~~~~~~~~~~~~~~~~~~~~~

1. **Use appropriate cache size** for your dataset
2. **Close unnecessary applications** when viewing large files
3. **Use frame caching** for smoother playback
4. **Reduce display resolution** for very large images

Troubleshooting
---------------

Common Issues
~~~~~~~~~~~~~

1. **File Loading Errors**
   - Check file format compatibility
   - Verify file permissions
   - Ensure sufficient memory for large files

2. **Performance Issues**
   - Reduce display resolution for large images
   - Close unnecessary applications
   - Use frame caching for smoother playback

3. **Display Problems**
   - Check graphics drivers
   - Try different interpolation methods
   - Reset display settings

Error Messages
~~~~~~~~~~~~~~

| Error              | Solution                                      |
| ------------------ | --------------------------------------------- |
| "Cannot load file" | Verify file is valid NPY format               |
| "Out of memory"    | Close other applications or use smaller files |
| "Invalid interval" | Check start/end frame values                  |

Keyboard Reference
------------------

File Operations
~~~~~~~~~~~~~~~

- **Ctrl+O**: Open file
- **Ctrl+S**: Save interval
- **Ctrl+Shift+S**: Save as
- **Ctrl+W**: Close file
- **Ctrl+Q**: Quit application

Navigation
~~~~~~~~~~

- **Space**: Play/Pause
- **→/←**: Next/Previous frame
- **Home/End**: First/Last frame
- **PgUp/PgDn**: Jump 10 frames

Display
~~~~~~~

- **+/-**: Zoom in/out
- **0**: Reset zoom
- **F**: Fullscreen mode
- **I**: Toggle information display
- **G**: Toggle grid

Analysis
~~~~~~~~

- **M**: Measurement mode
- **C**: Cell counting mode
- **H**: Toggle histogram
- **P**: Plot intensity profile

Integration with Cell-LISCA
--------------------------

Cell Viewer works seamlessly with other Cell-LISCA components:

Workflow Integration
~~~~~~~~~~~~~~~~~~~~

.. code-block:: bash

   # 1. Process with cell-filter
   cell-filter extract --input ./filtered --output ./extracted

   # 2. Analyze with cell-grapher (optional)
   cell-grapher --input ./extracted/data.npy --output ./analysis

   # 3. View and select intervals with cell-viewer
   cell-viewer
   # Then open files through the application

   # 4. Use selected intervals for further analysis

Data Transfer
~~~~~~~~~~~~~

- Cell Viewer can open NPY files directly from cell-filter output
- Selected intervals can be fed back into cell-grapher for focused analysis
- Metadata is preserved throughout the workflow

Use Cases
---------

Quality Control
~~~~~~~~~~~~~~

- Inspect segmentation quality
- Verify cell tracking results
- Check for artifacts or errors

Data Exploration
~~~~~~~~~~~~~~~

- Browse entire timelapse sequences
- Identify interesting events or transitions
- Compare different channels

Interval Selection
~~~~~~~~~~~~~~~~~

- Select specific time periods for analysis
- Extract sequences with particular events
- Create subsets for downstream processing

Presentation
~~~~~~~~~~~~

- Create visualizations for presentations
- Export annotated images
- Generate videos of cellular dynamics
